<!DOCTYPE html>
<html>
<head>
    <title>featureProgress</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var Ext=window.Ext4||window.Ext;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",title:"Test Status Panel",items:[{xtype:"container",itemId:"releaseFilter"},{xtype:"container",itemId:"dispGrid"}],launch:function(){this.down("#releaseFilter").add({xtype:"rallyreleasecombobox",itemId:"releaseComboBox",listeners:{change:this._queryForStoriesandPIs,ready:this._queryForStoriesandPIs,scope:this}})},_queryForStoriesandPIs:function(){void 0!==this._summaryGrid&&(this._summaryGrid.destroy(),this._Grid.destroy(),this._Grid2.destroy());var StoriesStore=Ext.create("Rally.data.WsapiDataStore",{model:"User Story",autoLoad:!0,storeId:"StoryStore",filters:[{property:"Feature.Release.Name",operator:"=",value:this.down("#releaseComboBox").getRecord().data.Name},{property:"DirectChildrenCount",operator:"=",value:0}],sorters:[{property:"Feature",direction:"ASC"}],fetch:["FormattedID","Name","ObjectID","Feature","Iteration","ScheduleState","Owner","StartDate"],listeners:{load:function(store,data,success){this._breakdownStoriesandFeatures(store,data)},scope:this}})},_organizeGridData:function(origArray){console.log("Organize Grid Data");var currentFeature="",currentIteration="",currentStories="",prevFeature="",prevIteration="",currentCount=0,totalRecords=origArray.length;console.log("Array count: ",totalRecords),console.log(origArray);var line=[],newArray=[],firstTimeFeature=!0;return Ext.Array.each(origArray,function(record){currentCount++,currentFeature=record.Feature,currentIteration=record.Iteration,line={Feature:"",Iteration:"",Story:""},currentCount==totalRecords?currentFeature==prevFeature?(currentIteration==prevIteration?(line.Feature="",line.Iteration=prevIteration,line.Story=currentStories+=record.Story):(firstTimeFeature?(line.Feature=currentFeature,firstTimeFeature=!1):line.Feature="",line.Iteration=prevIteration+="<BR>"+currentIteration,line.Story=currentStories+=record.Story),newArray.push(line)):(line.Feature="",line.Iteration=prevIteration,line.Story=currentStories,newArray.push(line),line.Feature=currentFeature,line.Iteration=currentIteration,line.Story=record.Story,newArray.push(line)):currentFeature==prevFeature?currentIteration==prevIteration?currentStories+=record.Story+"<BR>":(firstTimeFeature?(line.Feature=currentFeature,firstTimeFeature=!1):line.Feature="",line.Iteration=prevIteration,line.Story=currentStories,currentCount>1&&newArray.push(line),currentStories=record.Story+"<BR>",prevIteration=currentIteration):(firstTimeFeature?(line.Feature=currentFeature,firstTimeFeature=!1):line.Feature="",line.Iteration=prevIteration,line.Story=currentStories,newArray.push(line),prevFeature=currentFeature,prevIteration=currentIteration,currentStories=record.Story,firstTimeFeature=!0)}),console.log(newArray),newArray},_breakdownStoriesandFeatures:function(mystore,storydata){var that=this;that._FeatureList=[];var FeatureList=[],IterationList=[];Ext.Array.each(storydata,function(record){var featureName=record.get("Feature").Name,featureID=record.get("Feature").FormattedID;console.log("Feature id: ",featureID,"Feature name: ",featureName),FeatureList.push(featureID+": "+featureName);var iterationName=record.get("Iteration")||"unassigned",iterationDate;if("unassigned"!==iterationName){iterationName=record.get("Iteration").Name,iterationDate=record.get("Iteration").StartDate;var month=iterationDate.substr(5,2),day=iterationDate.substr(8,2),year=iterationDate.substr(0,4);iterationDate=year+month+day}else iterationDate=0;IterationList.push(iterationName);var storyID=record.get("FormattedID"),storyName=record.get("Name"),storyOwner=record.get("Owner")||"unassigned";"unassigned"!==storyOwner&&(storyOwner=record.get("Owner")._refObjectName),storyOwner='<font color="purple">'+storyOwner+"</font>";var storyStatus=record.get("ScheduleState");storyStatus="Completed"==storyStatus||"Accepted"==storyStatus?'<font color="green">'+storyStatus+"</font>":'<font color="red">'+storyStatus+"</font>",that._FeatureList.push({Feature:featureID+": "+featureName,Iteration:iterationName,Story:storyID+": "+storyName+" ("+storyStatus+", Owner: "+storyOwner+")"})}),that._uniqIterationList=IterationList.reduce(function(a,b){return 0>a.indexOf(b)&&a.push(b),a},[]),that._uniqFeatureList=FeatureList.reduce(function(a,b){return 0>a.indexOf(b)&&a.push(b),a},[]),console.log(that._uniqIterationList),console.log(that._uniqFeatureList),console.log(that._FeatureList);var uniqIterationList=that._uniqIterationList,uniqFeatureList=that._uniqFeatureList;FeatureList=that._FeatureList;var storiesbyfeature=[];Ext.Array.each(uniqFeatureList,function(featurerecord,index1){Ext.Array.each(FeatureList,function(record,index3){featurerecord==record.Feature&&(storiesbyfeature[index1]=void 0===storiesbyfeature[index1]?record.Story:storiesbyfeature[index1]+", "+record.Story)})});var storiesbyiteration=[];Ext.Array.each(uniqIterationList,function(iterationrecord,index1){Ext.Array.each(FeatureList,function(record,index3){iterationrecord==record.Iteration&&(storiesbyiteration[index1]=void 0===storiesbyiteration[index1]?record.Story:storiesbyiteration[index1]+", "+record.Story)})});var gridArray=this._organizeGridData(that._FeatureList);console.log("data organized"),console.log(gridArray),this._Grid=Ext.create("Rally.ui.grid.Grid",{xtype:"rallygrid",store:Ext.create("Rally.data.custom.Store",{storeId:"FeatureStoryStore",data:gridArray,autoScroll:!0,columnLines:!0}),title:"Feature Stories by Iteration",enableEditing:!0,columnCfgs:[{text:"Feature",dataIndex:"Feature",flex:2},{text:"Iteration",dataIndex:"Iteration",flex:1},{text:"Story",dataIndex:"Story",flex:3}]}),this.down("#dispGrid").add(this._Grid)}});

            Rally.launchApp('CustomApp', {
                name:"featureProgress",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
